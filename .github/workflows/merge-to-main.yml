name: Sync with S3 on Merge

on:
  push:
    branches:
      - main

jobs:
  sync-on-merge:
    runs-on: ubuntu-latest

    env:
      BUCKET_NAME: x
      S3_PREFIX: test-manifest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # Necesario para acceder a HEAD~1

      # - name: Configure AWS credentials
      #   uses: aws-actions/configure-aws-credentials@v2
      #   with:
      #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     aws-region: us-east-1

      - name: Detectar cambios dinÃ¡micamente en deploy/manifests/*
        run: |
          git diff --name-status --no-renames HEAD~1 HEAD -- deploy/manifests/ > changes.txt

          echo "ğŸ“„ Cambios aplicados en main:"
          cat changes.txt

          echo ""
          echo "âœ… ClasificaciÃ³n:"
          while IFS=$'\t' read -r status file; do
            case "$status" in
              A) echo "ğŸ†• Agregado: $file" ;;
              M) echo "âœï¸  Modificado: $file" ;;
              D) echo "âŒ Eliminado: $file" ;;
              *) echo "â“ Otro cambio ($status): $file" ;;
            esac
          done < changes.txt

          echo ""
          echo "ğŸ“ Carpetas afectadas:"
          cut -f2 changes.txt | awk -F'/' 'NF>=3 {print $1"/"$2"/"$3}' | sort -u > folders.txt
          cat folders.txt

      - name: Simular sync con S3 (modo dry-run)
        run: |
          echo ""
          echo "ğŸŒ Simulando sincronizaciÃ³n con S3:"
          while IFS=$'\t' read -r status file; do
            filename=$(basename "$file")
            case "$status" in
              D)
                echo "ğŸ—‘ Eliminar de S3: s3://$BUCKET_NAME/$S3_PREFIX/$filename"
                ;;
              M|A)
                echo "â¬†ï¸ Subir a S3: $file â†’ s3://$BUCKET_NAME/$S3_PREFIX/$filename"
                ;;
              *)
                echo "â“ Cambio no esperado ($status): $file"
                ;;
            esac
          done < changes.txt
