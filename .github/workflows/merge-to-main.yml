name: Sync with S3 on Merge

on:
  push:
    branches:
      - main

jobs:
  sync-on-merge:
    runs-on: ubuntu-latest

    env:
      BUCKET_NAME: x
      S3_PREFIX: test-manifest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # Necesario para acceder a HEAD~1

      # - name: Configure AWS credentials
      #   uses: aws-actions/configure-aws-credentials@v2
      #   with:
      #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     aws-region: us-east-1

      - name: Show merged changes
        run: |
          echo "üì¶ Cambios introducidos por el √∫ltimo merge a main:"

          # Sin detecci√≥n de renames para forzar add/delete en vez de rename
          git diff --name-status --no-renames HEAD~1 -- deploy/manifests/test-manifest/ > changes.txt

          cat changes.txt

      - name: Simular sync con S3 (modo dry-run)
        run: |
          echo ""
          echo "üåê Simulando sincronizaci√≥n con S3:"
          while IFS=$'\t' read -r status file; do
            filename=$(basename "$file")
            case "$status" in
              D)
                echo "üóë Eliminar de S3: s3://$BUCKET_NAME/$S3_PREFIX/$filename"
                ;;
              M|A)
                echo "‚¨ÜÔ∏è Subir a S3: $file ‚Üí s3://$BUCKET_NAME/$S3_PREFIX/$filename"
                ;;
              *)
                echo "‚ùì Cambio no esperado ($status): $file"
                ;;
            esac
          done < changes.txt
